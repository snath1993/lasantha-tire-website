// Daily Facebook Post with WhatsApp Approval
// 1. Generate content with AI at 8:30 AM
// 2. Send preview to admin via WhatsApp
// 3. Wait for "OK" reply
// 4. Auto-post to Facebook when approved
const cron = require('node-cron');
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const ImageGenerator = require('../utils/ImageGenerator');

class DailyFacebookPostJob {
  constructor(whatsappClient = null) {
    this.tasks = [];
    this.imageGen = new ImageGenerator();
    this.whatsapp = whatsappClient; // WhatsApp client for sending previews
    
    this.pageId = process.env.FACEBOOK_PAGE_ID;
    this.accessToken = process.env.FACEBOOK_PAGE_ACCESS_TOKEN;
    this.adminWhatsAppNumber = process.env.ADMIN_WHATSAPP_NUMBER; // Admin number for approvals
    
    // Gemini AI Setup
    this.geminiApiKey = process.env.GEMINI_API_KEY;
    if (this.geminiApiKey) {
      console.log('‚ú® Gemini AI is configured and ready!');
    } else {
      console.warn('‚ö†Ô∏è GEMINI_API_KEY not set - AI enhancement disabled');
    }

    // Pending posts waiting for approval
    this.pendingPosts = new Map(); // postId -> { content, imagePath, timestamp }
    
    // Draft storage directory
    this.draftsDir = path.join(__dirname, '../facebook-drafts');
    if (!fs.existsSync(this.draftsDir)) {
      fs.mkdirSync(this.draftsDir, { recursive: true });
    }
    
    if (!this.pageId || !this.accessToken) {
      console.error('‚ùå Facebook credentials missing in .env');
    }
    
    if (!this.adminWhatsAppNumber) {
      console.warn('‚ö†Ô∏è ADMIN_WHATSAPP_NUMBER not set in .env - approval system disabled');
    }
  }
  
  // Method to set WhatsApp client after initialization
  setWhatsAppClient(client) {
    this.whatsapp = client;
    console.log('‚úÖ WhatsApp client set for DailyFacebookPostJob');
  }
  
  start() {
    console.log('üìÖ Starting DailyFacebookPostJob (WhatsApp Approval Mode)...');
    
    // Daily Post Generation + WhatsApp Preview - 8:30 AM
    const dailyPost = cron.schedule('30 8 * * *', () => {
      this.generateAndSendForApproval();
    }, {
      timezone: 'Asia/Colombo'
    });
    
    this.tasks.push(dailyPost);
    
    console.log('‚úÖ Facebook post schedule:');
    console.log('   - Daily Generation: 8:30 AM');
    console.log('   - Preview sent to Admin via WhatsApp');
    console.log('   - Admin replies "OK" to approve');
    console.log('   - Auto-posts to Facebook when approved');
    console.log(`   - Admin WhatsApp: ${this.adminWhatsAppNumber || 'NOT SET'}`);
  }
  
  stop() {
    this.tasks.forEach(task => task.stop());
    console.log('‚èπÔ∏è DailyFacebookPostJob stopped');
  }
  
  // Generate post and send to admin for approval via WhatsApp
  async generateAndSendForApproval() {
    try {
      console.log('\nüìù Generating Facebook post for approval...');
      
      if (!this.whatsapp) {
        console.error('‚ùå WhatsApp client not available');
        return;
      }
      
      if (!this.adminWhatsAppNumber) {
        console.error('‚ùå Admin WhatsApp number not configured');
        return;
      }
      
      // Generate post content and image
      const post = await this.generatePost();
      
      // Create unique post ID
      const postId = `post_${Date.now()}`;
      
      // Store for later approval
      this.pendingPosts.set(postId, {
        content: post.content,
        imagePath: post.imagePath,
        timestamp: new Date().toISOString()
      });
      
      // Send to admin via WhatsApp
      await this.sendPreviewToAdmin(postId, post);
      
      console.log(`‚úÖ Preview sent to admin. Waiting for approval...`);
      console.log(`üì± Post ID: ${postId}`);
      
    } catch (err) {
      console.error('‚ùå Error in generateAndSendForApproval:', err.message);
    }
  }
  
  // Generate post content with AI
  async generatePost() {
    try {
      console.log('ü§ñ Generating content with AI...');
      
      // Generate content
      const templates = this.generateContentTemplates();
      const selectedTemplate = templates[0]; // Pick first one
      
      // Enhance with Gemini AI only
      let finalContent = selectedTemplate.content;
      if (this.geminiApiKey) {
        console.log('‚ú® Enhancing with Gemini AI...');
        const enhanced = await this.enhanceWithGemini(selectedTemplate);
        finalContent = enhanced.content;
      } else {
        console.log('‚ö†Ô∏è Gemini AI not configured, using template.');
      }
      
      console.log('‚úÖ Content generated');
      
      // Generate image
      console.log('üé® Generating image...');
      const imageBuffer = await this.imageGen.generateGenericPromotionalImage(
        selectedTemplate.type,
        selectedTemplate.theme
      );
      
      const imagePath = path.join(this.draftsDir, `temp_${Date.now()}.jpg`);
      fs.writeFileSync(imagePath, imageBuffer);
      console.log('‚úÖ Image generated');
      
      return {
        content: finalContent,
        imagePath: imagePath,
        type: selectedTemplate.type
      };
      
    } catch (err) {
      console.error('‚ùå Post generation error:', err.message);
      throw err;
    }
  }
  
  // Send preview to admin via WhatsApp
  async sendPreviewToAdmin(postId, post) {
    try {
      // Format number correctly for WhatsApp
      let chatId = this.adminWhatsAppNumber;
      
      // Remove any non-digit characters
      chatId = chatId.replace(/\D/g, '');
      
      // Add country code if not present
      if (!chatId.startsWith('94')) {
        if (chatId.startsWith('0')) {
          chatId = '94' + chatId.substring(1);
        }
      }
      
      // Add @c.us suffix
      chatId = chatId + '@c.us';
      
      console.log(`üì± Sending preview to ${chatId}`);
      
      // Send the image first
      const { MessageMedia } = require('whatsapp-web.js');
      const imageData = fs.readFileSync(post.imagePath, { encoding: 'base64' });
      const mediaFile = new MessageMedia('image/jpeg', imageData, 'preview.jpg');
      
      await this.whatsapp.sendMessage(chatId, mediaFile);
      console.log('‚úÖ Image sent');
      
      // Send the text content with instructions
      const previewMessage = `üì¢ *Facebook Post Preview*\n\n${post.content}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚úÖ *Reply "OK" to publish this post*\n‚ùå *Reply "CANCEL" to cancel*\n\nüìã Post ID: ${postId}`;
      
      await this.whatsapp.sendMessage(chatId, previewMessage);
      console.log('‚úÖ Text sent');
      
      console.log(`‚úÖ Preview sent to ${this.adminWhatsAppNumber}`);
      
    } catch (err) {
      console.error('‚ùå Error sending preview:', err.message);
      console.error('Error details:', err);
      throw err;
    }
  }
  
  // Handle approval from WhatsApp
  async handleApproval(postId, approved = true) {
    try {
      const post = this.pendingPosts.get(postId);
      
      if (!post) {
        console.error(`‚ùå Post ${postId} not found`);
        return false;
      }
      
      if (!approved) {
        console.log(`‚ùå Post ${postId} cancelled by admin`);
        this.pendingPosts.delete(postId);
        
        // Clean up temp image
        if (fs.existsSync(post.imagePath)) {
          fs.unlinkSync(post.imagePath);
        }
        
        return true;
      }
      
      // Approved - post to Facebook
      console.log(`‚úÖ Post ${postId} approved. Publishing to Facebook...`);
      
      const result = await this.postToFacebook(post.content, post.imagePath);
      
      // Clean up
      this.pendingPosts.delete(postId);
      if (fs.existsSync(post.imagePath)) {
        fs.unlinkSync(post.imagePath);
      }
      
      // Notify admin
      if (this.whatsapp && this.adminWhatsAppNumber) {
        const chatId = this.adminWhatsAppNumber + '@c.us';
        await this.whatsapp.sendMessage(
          chatId,
          `‚úÖ *Post Published Successfully!*\n\nüìã Facebook Post ID: ${result.id}\nüîó Your post is now live on your Facebook page!`
        );
      }
      
      console.log(`‚úÖ Post published: ${result.id}`);
      return true;
      
    } catch (err) {
      console.error('‚ùå Error handling approval:', err.message);
      
      // Notify admin of error
      if (this.whatsapp && this.adminWhatsAppNumber) {
        const chatId = this.adminWhatsAppNumber + '@c.us';
        await this.whatsapp.sendMessage(
          chatId,
          `‚ùå *Publishing Failed*\n\nError: ${err.message}\n\nPlease check the bot logs.`
        );
      }
      
      return false;
    }
  }
  
  // Post directly to Facebook (published immediately)
  async postToFacebook(content, imagePath) {
    try {
      console.log('üì§ Publishing to Facebook...');
      
      const FormData = require('form-data');
      const form = new FormData();
      
      form.append('message', content);
      form.append('access_token', this.accessToken);
      
      // Add image if available
      if (imagePath && fs.existsSync(imagePath)) {
        const imageBuffer = fs.readFileSync(imagePath);
        form.append('source', imageBuffer, {
          filename: 'post.jpg',
          contentType: 'image/jpeg'
        });
        
        const url = `https://graph.facebook.com/v18.0/${this.pageId}/photos`;
        const response = await axios.post(url, form, {
          headers: form.getHeaders(),
          maxContentLength: Infinity,
          maxBodyLength: Infinity
        });
        
        console.log('‚úÖ Published to Facebook!');
        return response.data;
        
      } else {
        // Text-only post
        const url = `https://graph.facebook.com/v18.0/${this.pageId}/feed`;
        const response = await axios.post(url, {
          message: content,
          access_token: this.accessToken
        });
        
        console.log('‚úÖ Published to Facebook!');
        return response.data;
      }
      
    } catch (err) {
      console.error('‚ùå Facebook posting error:', err.message);
      if (err.response) {
        console.error('Response:', err.response.data);
      }
      throw err;
    }
  }

  // Create daily draft (NO SQL, NO auto-posting)
  async createDailyDraft() {
    try {
      console.log('\nüìù Creating daily Facebook draft...');
      
      const timestamp = new Date().toISOString().split('T')[0];
      const draftId = `draft_${Date.now()}`;
      
      // Step 1: Generate base content templates (multiple options for admin to choose)
      const templates = this.generateContentTemplates();
      console.log(`‚úÖ Generated ${templates.length} content options`);
      
      // Step 2: Enhance with Gemini AI only
      const enhancedTemplates = [];
      for (const template of templates) {
        let enhancedTemplate = template;
        if (this.geminiApiKey) {
          console.log('‚ú® Enhancing with Gemini AI...');
          enhancedTemplate = await this.enhanceWithGemini(template);
        }
        enhancedTemplates.push(enhancedTemplate);
      }
      if (this.geminiApiKey) {
        console.log('‚úÖ Content enhanced with Gemini AI');
      } else {
        console.log('‚ÑπÔ∏è Gemini AI not configured, using base templates');
      }
      
      // Step 3: Generate sample images for each template
      console.log('üé® Generating sample images...');
      for (const template of enhancedTemplates) {
        try {
          // Create generic promotional image (no specific product/price)
          const imageBuffer = await this.imageGen.generateGenericPromotionalImage(
            template.type,
            template.theme
          );
          template.imagePath = path.join(this.draftsDir, `${draftId}_${template.type}.jpg`);
          fs.writeFileSync(template.imagePath, imageBuffer);
          console.log(`   ‚úÖ Image saved: ${template.type}.jpg`);
        } catch (err) {
          console.log(`   ‚ö†Ô∏è Image generation failed for ${template.type}`);
          template.imagePath = null;
        }
      }
      
      // Step 4: Save draft to JSON file
      const draft = {
        id: draftId,
        createdAt: new Date().toISOString(),
        status: 'pending_approval',
        templates: enhancedTemplates,
        notes: [
          '‚ö†Ô∏è NO product details, prices, or stock info included',
          '‚úÖ Add your own product/pricing manually before posting',
          '‚úÖ Admin must approve and post manually to Facebook',
          'üí° Choose one template, edit as needed, then post'
        ]
      };
      
      const draftPath = path.join(this.draftsDir, `${timestamp}_draft.json`);
      fs.writeFileSync(draftPath, JSON.stringify(draft, null, 2));
      
      console.log(`‚úÖ Draft saved: ${draftPath}`);
      console.log(`üìã ${enhancedTemplates.length} content options ready for review`);
      console.log('‚è≥ Awaiting admin approval...\n');
      
      // Step 5: Create summary HTML for easy viewing
      this.createDraftHTML(draft, timestamp);
      
      return draft;
      
    } catch (err) {
      console.error('‚ùå Draft creation error:', err.message);
      throw err;
    }
  }
  
  // Generate multiple content template options (NO SQL, NO specific products)
  generateContentTemplates() {
    const templates = [
      {
        type: 'general_promotion',
        theme: 'blue',
        content: `üéâ ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è‡∑Ä ‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂±! üéâ

Quality tyres ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂∏‡∑í‡∂Ω‡∂ú‡∂±‡∂±‡∑ä!

[‡∂î‡∂∂‡∑ö product details ‡∂∏‡∑ô‡∑Ñ‡∑í add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]

‚òéÔ∏è 077-777-7777
üìç Lasantha Tyre Traders

#LasanthaTyre #TyreDeals #SriLanka`,
        contentSinhala: `üéâ ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è‡∑Ä ‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂±! üéâ

‡∂ú‡∑î‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö tyres ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂∏‡∑í‡∂Ω‡∂ú‡∂±‡∂±‡∑ä!

[‡∂î‡∂∂‡∑ö product details ‡∂∏‡∑ô‡∑Ñ‡∑í add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]
[‡∂∏‡∑í‡∂Ω details add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]
[Stock details add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]

‡∂Ö‡∂∏‡∂≠‡∂±‡∑ä‡∂±: 077-777-7777
Lasantha Tyre Traders

#LasanthaTyre #QualityTyres`
      },
      {
        type: 'tips_and_advice',
        theme: 'green',
        content: `üí° Tyre Care Tip of the Day

[‡∂î‡∂∂‡∑ö tip ‡∂ë‡∂ö ‡∂∏‡∑ô‡∑Ñ‡∑í add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]

‡∂î‡∂∂‡∑ö tyres ‡∂Ø‡∑í‡∂ú‡∑î ‡∂ö‡∂Ω‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ä‡∑Ä‡∑è‡∂ú‡∂±‡∑ä‡∂±!

‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è:
‚òéÔ∏è 077-777-7777

#TyreCare #LasanthaTyre #SafetyFirst`,
        contentSinhala: `üí° ‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂± Tyre ‡∂ª‡∑ê‡∂ö‡∑Ä‡∂ª‡∂´ ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∂ö‡∑ä

[‡∂î‡∂∂‡∑ö tyre care tip ‡∂ë‡∂ö add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]

Expert advice ‡∑É‡∂≥‡∑Ñ‡∑è:
üìû 077-777-7777
Lasantha Tyre Traders

#TyreSafety #SriLanka`
      },
      {
        type: 'weekend_special',
        theme: 'orange',
        content: `üéä ‡∑É‡∂≠‡∑í ‡∂Ö‡∂±‡∑ä‡∂≠ ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è‡∑Ä! üéä

[‡∂î‡∂∂‡∑ö weekend offer details add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]

‡∂∏‡∑ô‡∂∏ ‡∑É‡∂≠‡∑í ‡∂Ö‡∂±‡∑ä‡∂≠‡∂∫‡∑ö ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä!

‚òéÔ∏è 077-777-7777
üìç Lasantha Tyre Traders

#WeekendSale #LasanthaTyre`,
        contentSinhala: `üåü Weekend Special Offer üåü

[Offer details add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]
[Discount % add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]

This weekend only!

‡∂Ö‡∂∏‡∂≠‡∂±‡∑ä‡∂±: 077-777-7777

#WeekendDeals #QualityTyres`
      },
      {
        type: 'customer_service',
        theme: 'blue',
        content: `üëã ‡∑É‡∑è‡∂Ø‡∂ª‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂ú‡∂±‡∑í‡∂∏‡∑î!

Lasantha Tyre Traders ‡∑Ñ‡∑í ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑É‡∑ö‡∑Ä‡∑è‡∑Ä‡∂±‡∑ä:

‚úÖ [Service 1]
‚úÖ [Service 2]  
‚úÖ [Service 3]

‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è:
üìû 077-777-7777

#CustomerService #LasanthaTyre`,
        contentSinhala: `‡∂Ö‡∂¥ ‡∑É‡∂∏‡∂ü ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∂±‡∑ä‡∂±!

‡∂î‡∂∂‡∑ö tyres ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂≠‡∑è ‡∑É‡∂≥‡∑Ñ‡∑è
‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç expert ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä

‚òéÔ∏è 077-777-7777
üìß [Your email]
üìç [Your location]

#ContactUs #TyreExperts`
      },
      {
        type: 'brand_showcase',
        theme: 'red',
        content: `‚≠ê Top Brand Tyres Available ‚≠ê

[‡∂î‡∂∂‡∑ö brand list add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]

‡∑Ä‡∑í‡∑Å‡∑ä‡∑Ä‡∑è‡∑É‡∂Ø‡∑è‡∂∫‡∂ö brands
‡∑Ñ‡∑ú‡∂≥‡∂∏ ‡∂∏‡∑í‡∂Ω‡∂ú‡∂±‡∂±‡∑ä

‚òéÔ∏è 077-777-7777

#BrandedTyres #LasanthaTyre`,
        contentSinhala: `üöó ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑î‡∂õ Brand Tyres üöó

[Brands list:]
- [Brand 1]
- [Brand 2]
- [Brand 3]

‡∂Ö‡∂∏‡∂≠‡∂±‡∑ä‡∂± ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è:
077-777-7777

#QualityBrands #SriLanka`
      }
    ];
    
    return templates;
  }
  
  // Enhance template with Gemini AI
  async enhanceWithGemini(template) {
    if (!this.geminiApiKey) {
      return template;
    }

    try {
      const prompt = `You are a creative social media expert for a tyre shop in Sri Lanka called "Lasantha Tyre Traders".

      üéØ **TARGET AUDIENCE:** Sri Lankan vehicle owners (cars, vans, bikes), aged 25-55. They value safety, good deals, and trustworthy service.

      üìù **YOUR TASK:** Rewrite this basic Facebook post into an engaging, creative, and persuasive masterpiece using a friendly, conversational mix of Sinhala and English (Singlish).

      **CREATIVE GUIDELINES:**
      1.  **HOOK:** Start with a relatable question or a surprising fact to grab attention. (e.g., "‡∂∏‡∑ö ‡∑Ä‡∑ê‡∑É‡∑ä‡∑É‡∂ß ‡∂¥‡∑è‡∂ª‡∑ö brake ‡∂¥‡∑ë‡∂ú‡∑î‡∑Ä‡∂∏ ‡∑Ä‡∑è‡∑Ñ‡∂±‡∑ö ‡∂Ω‡∑í‡∑É‡∑ä‡∑É‡∂±‡∑Ä‡∂Ø? üò≤", "‡∂î‡∂∂‡∑ö ‡∑Ä‡∑è‡∑Ñ‡∂±‡∑ö ‡∂ß‡∂∫‡∂ª‡∑ä ‡∂∏‡∑è‡∂ª‡∑î ‡∂ö‡∂ª‡∂Ω‡∑è ‡∂ö‡∑ú‡∂†‡∑ä‡∂†‡∂ª ‡∂ö‡∂Ω‡∑ä‡∂Ø?")
      2.  **LANGUAGE:** Use natural Singlish. Be friendly and approachable, not overly formal. (e.g., "check ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±," "‡∑É‡∑î‡∂¥‡∑í‡∂ª‡∑í‡∂∏ deal," "‡∂Ö‡∂Ø‡∂∏ ‡∂ö‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±").
      3.  **EMOJIS:** Use emojis strategically to add visual appeal and emotion (e.g., üöó, üí®, ‚ú®, ‚úÖ, üíØ, üë®‚Äçüë©‚Äçüëß‚Äçüë¶, üìû).
      4.  **STRUCTURE:**
          *   **Catchy Hook:** 1-2 lines.
          *   **Value/Benefit:** Use bullet points (‚úÖ) to highlight what the customer gets.
          *   **Call to Action (CTA):** Clear and direct instruction (e.g., "‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ö‡∂Ø‡∂∏ ‡∂ö‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!", "Visit us today!").
      5.  **TONE:** Helpful, expert, and trustworthy. Show that you care about the customer's safety.
      6.  **IMPORTANT:** Keep all placeholders like \`[‡∂î‡∂∂‡∑ö product details ‡∂∏‡∑ô‡∑Ñ‡∑í add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±]\` exactly as they are. Do NOT add real product names, prices, or stock details.

      **ORIGINAL POST TO REWRITE:**
      \`\`\`
      ${template.content}
      \`\`\`

      **NOW, CREATE THE ENHANCED VERSION (under 150 words):**`;

      // Use REST API directly
      const response = await axios.post(
        `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${this.geminiApiKey}`,
        {
          contents: [{
            parts: [{
              text: prompt
            }]
          }]
        },
        {
          headers: {
            'Content-Type': 'application/json'
          }
        }
      );

      const enhancedText = response.data?.candidates?.[0]?.content?.parts?.[0]?.text || template.content;

      return {
        ...template,
        content: enhancedText,
        originalContent: template.content,
        enhanced: true,
        aiProvider: 'Gemini'
      };

    } catch (err) {
      console.error('‚ùå Gemini enhancement error:', err.response?.data || err.message);
      // Fallback to original template
      return template;
    }
  }

  // Generate multiple content template options (NO SQL, NO specific products)
  generateContentTemplates() {
    if (!this.hfApiKey) return template;

    try {
      const prompt = `You are a creative social media expert for a tyre shop in Sri Lanka called "Lasantha Tyre Traders".

Use a friendly Sinhala-English (Singlish) tone that feels local.
KEEP ALL placeholders like [‡∂î‡∂∂‡∑ö product details ‡∂∏‡∑ô‡∑Ñ‡∑í add ‡∂ö‡∂ª‡∂±‡∑ä‡∂±] intact.
Do not invent prices or stock.

Original:
${template.content}

Rewrite under 150 words with:
- A catchy hook
- 2-3 value bullets (‚úÖ)
- Clear CTA with a phone number placeholder
`;

      const url = `https://api-inference.huggingface.co/models/${encodeURIComponent(this.hfModel)}`;
      const response = await axios.post(
        url,
        {
          inputs: prompt,
          parameters: {
            max_new_tokens: 180,
            temperature: 0.8,
            top_p: 0.9,
            return_full_text: false
          }
        },
        {
          headers: {
            Authorization: `Bearer ${this.hfApiKey}`,
            'Content-Type': 'application/json'
          },
          timeout: 30000
        }
      );

      let enhancedText = '';
      if (Array.isArray(response.data) && response.data.length > 0) {
        enhancedText = response.data[0]?.generated_text || '';
      } else if (typeof response.data === 'string') {
        enhancedText = response.data;
      } else if (response.data?.generated_text) {
        enhancedText = response.data.generated_text;
      }

      enhancedText = (enhancedText || '').trim();
      if (!enhancedText) return template;

      return {
        ...template,
        content: enhancedText,
        originalContent: template.content,
        enhanced: true,
        aiProvider: 'HuggingFace'
      };
    } catch (err) {
      const details = err.response?.data || err.message;
      console.error('‚ùå Hugging Face enhancement error:', details);
      return template;
    }
  }

  // Enhance template with Ollama (keep it generic, no specific products/prices)
  async enhanceWithOllama(template) {
    if (!this.ollama.isAvailable) {
      return template;
    }
    
    try {
      const prompt = `You are a creative social media expert for Lasantha Tyre Traders in Sri Lanka.

üéØ TARGET AUDIENCE: Sri Lankan car owners aged 25-50, middle-class families, business owners

üìù YOUR TASK: Transform this Facebook post into an ATTENTION-GRABBING, ENGAGING masterpiece!

‚ú® CREATIVE GUIDELINES:
1. START WITH A HOOK - Begin with something that makes people STOP scrolling:
   - Ask a relatable question (e.g., "‡∂∏‡∑ö ‡∂Ø‡∑Ä‡∑É‡∑ä ‡∑Ä‡∂Ω ‡∑Ä‡∑ê‡∑Ñ‡∑í ‡∑Ä‡∑ê‡∑Ñ‡∑î‡∂´‡∂∏ road ‡∂ë‡∂ö‡∑ö ‡∂∫‡∂±‡∑ä‡∂± ‡∂∂‡∂∫‡∂∫‡∑í ‡∂±‡∑ö‡∂Ø?")
   - Share a surprising fact (e.g., "80% accidents happen because of worn out tyres!")
   - Use emotional triggers (safety, family protection, saving money)

2. LANGUAGE STYLE:
   - Natural Sinhala-English mix (Singlish) - like talking to a friend
   - Use conversational tone, not formal/corporate
   - Examples: "‡∂ë‡∂¥‡∑è ‡∑Ä‡∑ô‡∂Ω‡∑è" not "‡∂Ö‡∂¥‡∑ä‚Äç‡∂ª‡∑É‡∂±‡∑ä‡∂±", "check ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" not "‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"

3. EMOJI USAGE (Strategic, not spammy):
   - üöóüõû for tyres/cars
   - üèÜ‚ú®üíØ for quality/excellence
   - üë®‚Äçüë©‚Äçüëß‚Äçüë¶üíö for family/safety
   - üìû‚òéÔ∏è for contact
   - ‚ö†Ô∏èüí°‚úÖ for tips/warnings/benefits

4. CONTENT STRUCTURE:
   - Opening: Catchy hook (1 sentence)
   - Middle: Key benefits or value (2-3 points, use ‚úÖ or üí°)
   - Closing: Clear call-to-action + contact info

5. PERSONALITY:
   - Friendly local expert (not corporate)
   - Helpful and caring (about customer safety)
   - Professional but approachable
   - Use storytelling when possible

6. PLACEHOLDERS:
   - KEEP all [brackets] and placeholders intact
   - DO NOT add specific products, prices, or stock numbers
   - These will be filled by admin later

ORIGINAL POST:
${template.content}

NOW CREATE: A magnetic, scroll-stopping, engagement-boosting version (under 200 words) that makes people:
- STOP and read
- FEEL something (safety, trust, excitement)
- TAKE ACTION (call, visit, engage)

Enhanced creative version:`;

      const response = await this.ollama.ollama.generate({
        model: this.ollama.defaultModel,
        prompt: prompt,
        stream: false,
        options: {
          temperature: 0.8, // Increased for more creativity
          num_predict: 400, // More tokens for detailed content
          top_p: 0.9
        }
      });
      
      const enhanced = response.response || template.content;
      
      return {
        ...template,
        content: enhanced,
        originalContent: template.content,
        enhanced: true
      };
      
    } catch (err) {
      console.error('Enhancement error:', err.message);
      return template;
    }
  }
  
  // Create HTML file for easy viewing of drafts
  createDraftHTML(draft, timestamp) {
    const html = `<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facebook Draft - ${timestamp}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .template {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .template-type {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .content {
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #667eea;
      margin: 15px 0;
    }
    .image {
      max-width: 100%;
      border-radius: 10px;
      margin: 15px 0;
    }
    .notes {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      margin: 5px 5px 5px 0;
    }
    .badge-ai {
      background: #d4edda;
      color: #155724;
    }
    .badge-template {
      background: #d1ecf1;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìù Facebook Draft Created</h1>
    <p>Created: ${draft.createdAt}</p>
    <p>Status: <strong>${draft.status}</strong></p>
    <p>Draft ID: ${draft.id}</p>
  </div>
  
  <div class="notes">
    <h3>‚ö†Ô∏è ‡∑Ä‡∑ê‡∂Ø‡∂ú‡∂≠‡∑ä ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä:</h3>
    ${draft.notes.map(note => `<p>${note}</p>`).join('')}
  </div>
  
  <h2>Content Options (${draft.templates.length} available):</h2>
  
  ${draft.templates.map((template, index) => `
    <div class="template">
      <h3>Option ${index + 1}</h3>
      <span class="template-type">${template.type}</span>
      ${template.enhanced ? '<span class="badge badge-ai">‚ú® AI Enhanced</span>' : '<span class="badge badge-template">üìÑ Template</span>'}
      
      <div class="content">${template.content}</div>
      
      ${template.contentSinhala ? `
        <h4>Alternative (Sinhala):</h4>
        <div class="content">${template.contentSinhala}</div>
      ` : ''}
      
      ${template.imagePath && fs.existsSync(template.imagePath) ? `
        <h4>Sample Image:</h4>
        <img src="file:///${template.imagePath}" class="image" alt="Sample image">
        <p><small>Image path: ${template.imagePath}</small></p>
      ` : '<p><em>No image generated</em></p>'}
    </div>
  `).join('')}
  
  <div class="notes">
    <h3>üìã Next Steps:</h3>
    <ol>
      <li>Choose one content option above</li>
      <li>Add your product details (name, size, brand)</li>
      <li>Add pricing information</li>
      <li>Add stock availability</li>
      <li>Review and edit the text as needed</li>
      <li>Post manually to Facebook Page</li>
    </ol>
  </div>
  
  <footer style="text-align: center; margin-top: 40px; color: #666;">
    <p>Generated by Lasantha Tyre Automation System</p>
    <p>üí∞ Cost: Rs. 0 (FREE with Ollama)</p>
  </footer>
</body>
</html>`;
    
    const htmlPath = path.join(this.draftsDir, `${timestamp}_draft.html`);
    fs.writeFileSync(htmlPath, html);
    console.log(`üìÑ HTML preview saved: ${htmlPath}`);
  }
  

  
  // Manual trigger for testing (simulates WhatsApp approval flow)
  async testWithSimulatedApproval() {
    console.log('üß™ Testing post generation and auto-approval...');
    
    // Generate post
    const post = await this.generatePost();
    
    console.log('\nüìÑ Generated Post:');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(post.content);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`üì∑ Image: ${post.imagePath}`);
    
    // Simulate approval (auto-post for testing)
    console.log('\n‚úÖ Auto-approving for test...');
    const result = await this.postToFacebook(post.content, post.imagePath);
    
    // Clean up
    if (fs.existsSync(post.imagePath)) {
      fs.unlinkSync(post.imagePath);
    }
    
    console.log(`\n‚úÖ Test complete! Post ID: ${result.id}`);
    return result;
  }
  
  // Get list of pending drafts
  getPendingDrafts() {
    const files = fs.readdirSync(this.draftsDir)
      .filter(f => f.endsWith('_draft.json'))
      .map(f => {
        const content = JSON.parse(fs.readFileSync(path.join(this.draftsDir, f), 'utf8'));
        return {
          filename: f,
          ...content
        };
      })
      .filter(d => d.status === 'pending_approval')
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    return files;
  }
}

module.exports = DailyFacebookPostJob;

// Test if run directly: node jobs/DailyFacebookPostJob.js
if (require.main === module) {
  require('dotenv').config();
  const job = new DailyFacebookPostJob();
  
  // Test post generation and publishing
  job.testWithSimulatedApproval()
    .then(() => {
      console.log('\n‚úÖ Test complete!');
      console.log('\nüìã What happened:');
      console.log('   1. Generated content with AI');
      console.log('   2. Created promotional image');
      console.log('   3. Posted directly to Facebook');
      console.log('\nüëâ Check your Facebook Page to see the post!');
      console.log('\nüí° In production:');
      console.log('   - Post will be sent to WhatsApp first');
      console.log('   - Admin replies "OK" to approve');
      console.log('   - Then it auto-posts to Facebook');
      process.exit(0);
    })
    .catch(err => {
      console.error('‚ùå Test failed:', err);
      process.exit(1);
    });
}
