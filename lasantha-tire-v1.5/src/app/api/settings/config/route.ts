import { NextRequest, NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

const CONFIG_FILE = path.join(process.cwd(), '..', 'config.js');
const ENV_FILE = path.join(process.cwd(), '..', '.env');

// Parse .env file
function parseEnvFile(content: string): Record<string, string> {
  const config: Record<string, string> = {};
  const lines = content.split('\n');
  
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;
    
    const match = trimmed.match(/^([^=]+)=(.*)$/);
    if (match) {
      const key = match[1].trim();
      let value = match[2].trim();
      
      // Remove quotes if present
      if ((value.startsWith('"') && value.endsWith('"')) || 
          (value.startsWith("'") && value.endsWith("'"))) {
        value = value.slice(1, -1);
      }
      
      config[key] = value;
    }
  }
  
  return config;
}

// Generate .env file content
function generateEnvFile(config: Record<string, string>): string {
  const lines: string[] = [
    '# WhatsApp SQL API Configuration',
    '# Auto-generated by Dashboard',
    '# Last updated: ' + new Date().toISOString(),
    '',
    '# ===== Database Configuration =====',
    `SQL_SERVER=${config.SQL_SERVER || 'localhost'}`,
    `SQL_USER=${config.SQL_USER || 'sa'}`,
    `SQL_PASSWORD=${config.SQL_PASSWORD || ''}`,
    `SQL_DATABASE=${config.SQL_DATABASE || 'TYREDB'}`,
    `SQL_PORT=${config.SQL_PORT || '1433'}`,
    `DB_ENCRYPT=${config.DB_ENCRYPT || 'false'}`,
    `DB_TRUST_CERT=${config.DB_TRUST_CERT || 'true'}`,
    '',
    '# ===== Bot & WhatsApp Settings =====',
    `BOT_API_PORT=${config.BOT_API_PORT || '3100'}`,
    `ADMIN_NUMBERS=${config.ADMIN_NUMBERS || '0771222509'}`,
    `ADMIN_WHATSAPP_NUMBER=${config.ADMIN_WHATSAPP_NUMBER || '0771222509'}`,
    `DAILY_REPORT_NUMBERS=${config.DAILY_REPORT_NUMBERS || '0771222509'}`,
    `ALLOWED_NUMBERS=${config.ALLOWED_NUMBERS || ''}`,
    `SCHEDULER_ENABLED=${config.SCHEDULER_ENABLED || '1'}`,
    '',
    '# ===== AI & API Keys =====',
    `ENABLE_AI_COPILOT=${config.ENABLE_AI_COPILOT || 'true'}`,
    `AI_CONTEXT_MESSAGES=${config.AI_CONTEXT_MESSAGES || '5'}`,
    `ANTHROPIC_API_KEY=${config.ANTHROPIC_API_KEY || ''}`,
    `GEMINI_API_KEY=${config.GEMINI_API_KEY || ''}`,
    `FB_POST_AI_PROVIDER=${config.FB_POST_AI_PROVIDER || 'claude'}`,
    '',
    '# ===== Facebook Integration =====',
    `FACEBOOK_PAGE_ID=${config.FACEBOOK_PAGE_ID || ''}`,
    `FACEBOOK_PAGE_ACCESS_TOKEN=${config.FACEBOOK_PAGE_ACCESS_TOKEN || ''}`,
    `FB_PUBLISH_MODE=${config.FB_PUBLISH_MODE || 'draft'}`,
    `FB_APPROVAL_MODE=${config.FB_APPROVAL_MODE || 'whatsapp'}`,
    `AUTO_REANALYZE_POST_STYLE=${config.AUTO_REANALYZE_POST_STYLE || 'false'}`,
    `ENABLE_AB_DRAFTS=${config.ENABLE_AB_DRAFTS || 'true'}`,
    `AB_VARIANT_COUNT=${config.AB_VARIANT_COUNT || '2'}`,
    `LOCAL_PREVIEW_ONLY=${config.LOCAL_PREVIEW_ONLY || 'false'}`,
    '',
    '# ===== Store Information =====',
    `STORE_NAME=${config.STORE_NAME || 'Lasantha Tyre Traders'}`,
    `STORE_PHONE=${config.STORE_PHONE || '0721222509'}`,
    `STORE_LOCATION=${config.STORE_LOCATION || 'Thalawathugoda'}`,
    `STORE_HOURS=${config.STORE_HOURS || '06:30-21:00'}`,
    `STORE_WHEEL_ALIGNMENT_HOURS=${config.STORE_WHEEL_ALIGNMENT_HOURS || '07:30-18:00'}`,
    `AUTH_BADGE_TEXT=${config.AUTH_BADGE_TEXT || 'Authorised Dealer'}`,
    `TAGLINE_SI=${config.TAGLINE_SI || ''}`,
    `TAGLINE_EN=${config.TAGLINE_EN || ''}`,
    `LOGO_PATH=${config.LOGO_PATH || ''}`,
    '',
    '# ===== Image & Poster Settings =====',
    `POST_IMAGE_MODE=${config.POST_IMAGE_MODE || 'generate'}`,
    `EXTERNAL_IMAGE_DIR=${config.EXTERNAL_IMAGE_DIR || ''}`,
    `POSTER_TEMPLATE_DIR=${config.POSTER_TEMPLATE_DIR || 'C:/Users/Cashi/Music'}`,
    `FORCE_LAYOUT=${config.FORCE_LAYOUT || ''}`,
    `FORCE_PALETTE=${config.FORCE_PALETTE || ''}`,
    `FORCE_TEMPLATE_ID=${config.FORCE_TEMPLATE_ID || ''}`,
    '',
    '# ===== Pricing Rules =====',
    `COST_ADD_BASE=${config.COST_ADD_BASE || '1500'}`,
    `COST_ADD_CREDIT=${config.COST_ADD_CREDIT || '500'}`,
    `MIN_TYRE_COST=${config.MIN_TYRE_COST || '3000'}`,
    `QUOTE_DIR=${config.QUOTE_DIR || 'C:/QUOTE'}`,
    '',
    '# ===== System & Logging =====',
    `LOG_LEVEL=${config.LOG_LEVEL || 'info'}`,
    `LOG_MAX_BYTES=${config.LOG_MAX_BYTES || '2000000'}`,
    `BOT_PORT_MAX_TRIES=${config.BOT_PORT_MAX_TRIES || '10'}`,
    ''
  ];
  
  return lines.join('\n');
}

export async function GET() {
  try {
    let config: Record<string, string> = {};
    
    // Try to read .env file
    if (fs.existsSync(ENV_FILE)) {
      const content = fs.readFileSync(ENV_FILE, 'utf-8');
      config = parseEnvFile(content);
    }
    
    return NextResponse.json({
      success: true,
      config
    });
  } catch (error) {
    console.error('Failed to read config:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to read configuration' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { config } = body;
    
    if (!config || typeof config !== 'object') {
      return NextResponse.json(
        { success: false, error: 'Invalid configuration data' },
        { status: 400 }
      );
    }
    
    // Generate .env file content
    const envContent = generateEnvFile(config);
    
    // Write to .env file
    fs.writeFileSync(ENV_FILE, envContent, 'utf-8');
    
    // Also update config.js if needed
    const configJsContent = `// Central runtime configuration (auto-generated). Adjust values via .env
require('dotenv').config();

function list(name, def='') {
  return (process.env[name] || def).split(',').map(s=>s.trim()).filter(Boolean);
}
function int(name, def) { const v = parseInt(process.env[name] || '', 10); return isNaN(v)? def : v; }

module.exports = {
  QUOTE_DIR: process.env.QUOTE_DIR || 'C:/QUOTE',
  ADMIN_NUMBERS: list('ADMIN_NUMBERS','0771222509'),
  DAILY_REPORT_NUMBERS: list('DAILY_REPORT_NUMBERS','0771222509'),
  ALLOWED_NUMBERS: list('ALLOWED_NUMBERS',''),
  SCHEDULER_ENABLED: (process.env.SCHEDULER_ENABLED === '1'),
  COST_ADD_BASE: int('COST_ADD_BASE',1500),
  COST_ADD_CREDIT: int('COST_ADD_CREDIT',500),
  MIN_TYRE_COST: int('MIN_TYRE_COST',3000),
  LOG_LEVEL: process.env.LOG_LEVEL || 'info'
};
`;
    
    fs.writeFileSync(CONFIG_FILE, configJsContent, 'utf-8');
    
    return NextResponse.json({
      success: true,
      message: 'Configuration saved successfully',
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Failed to save config:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to save configuration' },
      { status: 500 }
    );
  }
}
