const { replyToComment } = require('./facebookApi');
const { extractTyreSizeFlexible } = require('./detect');
const { fetchTyreData } = require('./fetchTyreData');
const { GoogleGenerativeAI } = require('@google/generative-ai');
const { storeContext, getContext } = require('./facebookConversationContext');
const fs = require('fs');
const path = require('path');

// Use public-facing phone number from environment (falls back to hardcoded if not set)
const WHATSAPP_NUMBER = process.env.STORE_PHONE || process.env.WHATSAPP_PRIMARY_NUMBER || '0721222509';
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// Load brand categories from config
let brandCategoriesConfig = null;
try {
    const configPath = path.join(__dirname, '..', 'brand-categories.json');
    brandCategoriesConfig = JSON.parse(fs.readFileSync(configPath, 'utf8'));
    console.log('[FB Handler] Loaded brand categories config');
} catch (error) {
    console.warn('[FB Handler] Failed to load brand-categories.json, using defaults:', error.message);
}

// ========================================
// DUPLICATE REPLY GUARD
// ========================================
const processedComments = new Map(); // Map<comment_id, timestamp>
const PROCESSED_TTL = 60 * 60 * 1000; // 1 hour

function isAlreadyProcessed(commentId) {
    const now = Date.now();
    
    // Cleanup expired entries
    for (const [id, timestamp] of processedComments.entries()) {
        if (now - timestamp > PROCESSED_TTL) {
            processedComments.delete(id);
        }
    }
    
    // Check if already processed
    if (processedComments.has(commentId)) {
        const processedAt = processedComments.get(commentId);
        const ageMinutes = Math.round((now - processedAt) / 1000 / 60);
        console.log(`[FB Handler] ‚è≠Ô∏è  Comment ${commentId} already processed ${ageMinutes}m ago - skipping`);
        return true;
    }
    
    return false;
}

function markAsProcessed(commentId) {
    processedComments.set(commentId, Date.now());
}

async function handleFacebookComment(commentEvent, mainPool) {
    try {
        const { comment_id, message, from, verb, parent_id } = commentEvent;
        const FB_PAGE_ID = process.env.FACEBOOK_PAGE_ID || '194559142002903';
        
        // Check if already processed (duplicate event)
        if (isAlreadyProcessed(comment_id)) {
            return;
        }
        
        if (verb === 'remove' || verb === 'edit') return;
        if (from.id === FB_PAGE_ID) return;
        if (!message || message.trim().length === 0) return;
        
        // Mark as being processed
        markAsProcessed(comment_id);
        
        console.log(`[FB] Comment from ${from.name}: ${message}`);
        console.log(`[FB] Parent ID: ${parent_id || 'NONE'}`);
        
        const language = detectLanguage(message);
        
        // Check if this is a reply to our previous comment (continuation)
        const parentContext = parent_id ? getContext(parent_id) : null;
        
        if (parentContext) {
            console.log(`[FB Handler] üîÑ Found context! Previous size: ${parentContext.tyreSize}, Brands: ${parentContext.brands?.join(', ')}`);
            
            // This is a follow-up question - handle contextually
            const response = await handleContextualReply(message, parentContext, language, mainPool);
            await replyToComment(comment_id, response);
            
            // Store context for this new reply too (for further continuation)
            storeContext(comment_id, {
                tyreSize: parentContext.tyreSize,
                brands: parentContext.brands,
                originalQuery: parentContext.originalQuery,
                followUp: message
            });
            
            console.log('[FB] Contextual response sent');
            return;
        }
        
        // No parent context - this is a new query
        const tyreSize = extractTyreSizeFlexible(message);
        
        console.log(`[FB Handler] üîç Detected language: ${language}`);
        console.log(`[FB Handler] üîç Detected tyre size: ${tyreSize || 'NONE'}`);
        
        let response = '';
        let brandsAvailable = [];
        
        if (tyreSize) {
            console.log(`[FB Handler] ‚úÖ Size detected, querying database for: ${tyreSize}`);
            try {
                // Ensure pool is connected before querying
                await mainPool;
                
                const result = await fetchTyreData(mainPool, tyreSize);
                console.log(`[FB Handler] üì¶ Database returned ${result?.tyres?.length || 0} tyres`);
                
                if (result && result.tyres && result.tyres.length > 0) {
                    brandsAvailable = [...new Set(result.tyres.map(t => t.BrandName || t.normBrand || t.brand))].filter(b => b);
                    response = buildWhatsAppLink(tyreSize, result.tyres, language);
                    console.log(`[FB Handler] ‚úÖ Built reply with brands`);
                } else {
                    console.log(`[FB Handler] ‚ö†Ô∏è No stock, using AI fallback`);
                    response = await generateAI(message, 'no_stock', tyreSize, language);
                }
            } catch (error) {
                console.error(`[FB Handler] ‚ùå Database error:`, error.message);
                response = await generateAI(message, 'error', tyreSize, language);
            }
        } else {
            console.log(`[FB Handler] ‚ÑπÔ∏è No size detected, using AI general response`);
            response = await generateAI(message, 'general', null, language);
        }
        
        await replyToComment(comment_id, response);
        
        // Store context for potential follow-up questions
        if (tyreSize && brandsAvailable.length > 0) {
            storeContext(comment_id, {
                tyreSize: tyreSize,
                brands: brandsAvailable,
                originalQuery: message
            });
            console.log(`[FB Handler] üíæ Stored context for comment ${comment_id}`);
        }
        
        console.log('[FB] Response sent');
    } catch (error) {
        console.error('[FB] Error:', error.message);
    }
}

function buildWhatsAppLink(size, data, lang) {
    // Helper function to remove tyre size from description (with regex for variants)
    const removeSizeFromDescription = (description, tyreSize) => {
        if (!description) return '';
        
        // Create regex patterns for size variants
        // e.g., 185/65R15, 185/65/15, 185 65 R15, etc.
        const normalized = tyreSize.replace(/[\/\-\s]/g, '');
        const patterns = [
            tyreSize,  // Original format
            tyreSize.replace(/R/gi, ''),  // Without R
            tyreSize.replace(/R/gi, '/'),  // R as slash
            tyreSize.replace(/[\/\-]/g, ' '),  // Spaces instead of separators
            normalized  // All together
        ];
        
        let cleaned = description;
        patterns.forEach(pattern => {
            const regex = new RegExp(pattern.replace(/[\/\-\s]/g, '[\\s\\/\\-]*'), 'gi');
            cleaned = cleaned.replace(regex, '');
        });
        
        // Clean up extra whitespace
        return cleaned.replace(/\s+/g, ' ').trim();
    };
    
    // Get brand categories from config or use defaults
    const categories = brandCategoriesConfig?.categories || {
        performance: { brands: ['GT', 'MAXXIS', 'MAXXIES', 'MICHELIN', 'BRIDGESTONE', 'GITI'] },
        valueDurability: { brands: ['DURATURN', 'LANVIGATOR', 'WINDFORCE'] }
    };
    
    const rules = brandCategoriesConfig?.rules || {
        maxItemsBeforeTruncation: 15,
        truncationMessage_si: '‚Ä¢ (‡∂≠‡∑Ä‡∂≠‡∑ä ‡∑Ä‡∑í‡∂ö‡∂Ω‡∑ä‡∂¥ WhatsApp link ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±)',
        truncationMessage_en: '‚Ä¢ (See remaining options via WhatsApp link)'
    };
    
    // Get all unique items with their full descriptions
    const allItems = data.map(t => ({
        brand: (t.BrandName || t.normBrand || t.brand || '').toUpperCase(),
        description: t.ItemDescription || t.Description || ''
    }));
    
    // Remove duplicates based on description
    const uniqueItems = Array.from(
        new Map(allItems.map(item => [item.description, item])).values()
    );
    
    // Categorize items based on config
    const performanceBrands = categories.performance.brands.map(b => b.toUpperCase());
    const valueDurabilityBrands = categories.valueDurability.brands.map(b => b.toUpperCase());
    
    const performanceItems = uniqueItems.filter(item => 
        performanceBrands.includes(item.brand)
    );
    
    const valueDurabilityItems = uniqueItems.filter(item => 
        valueDurabilityBrands.includes(item.brand)
    );
    
    const otherItems = uniqueItems.filter(item => 
        !performanceBrands.includes(item.brand) && !valueDurabilityBrands.includes(item.brand)
    );

    if (lang === 'si') {
        // Sinhala Format with full descriptions
        const link = `https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`Expert advice for ${size}`)}`;
        
        let reply = `‚úÖ ‡∑É‡∑ä‡∂≠‡∑ñ‡∂≠‡∑í‡∂∫‡∑í. ‡∂î‡∂∂‡∂ú‡∑ö ‡∑Ä‡∑í‡∂∏‡∑É‡∑ì‡∂∏ ‡∂¥‡∂ª‡∑í‡∂Ø‡∑í, ${size} ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫‡∑ö ‡∂ß‡∂∫‡∂ª‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∑í‡∂ö‡∂Ω‡∑ä‡∂¥ ‡∂ö‡∑í‡∑Ñ‡∑í‡∂¥‡∂∫‡∂ö‡∑ä ‡∂Ö‡∂¥ ‡∑É‡∂≠‡∑î‡∑Ä ‡∂á‡∂≠.\n\n`;
        
        reply += `üåü **‡∂Ö‡∂¥‡∑ö Expert's Choice:**\n\n`;
        
        let itemCount = 0;
        const maxItems = rules.maxItemsBeforeTruncation;
        let wasTruncated = false;
        
        if (performanceItems.length > 0) {
            reply += `**Performance:**\n`;
            for (let i = 0; i < performanceItems.length; i++) {
                if (itemCount >= maxItems) {
                    wasTruncated = true;
                    break;
                }
                const item = performanceItems[i];
                const cleanDesc = removeSizeFromDescription(item.description, size);
                reply += `  ‚Ä¢ ${cleanDesc}\n`;
                itemCount++;
            }
            reply += `\n`;
        }
        
        if (!wasTruncated && valueDurabilityItems.length > 0) {
            reply += `**Value & Durability:**\n`;
            for (let i = 0; i < valueDurabilityItems.length; i++) {
                if (itemCount >= maxItems) {
                    wasTruncated = true;
                    break;
                }
                const item = valueDurabilityItems[i];
                const cleanDesc = removeSizeFromDescription(item.description, size);
                reply += `  ‚Ä¢ ${cleanDesc}\n`;
                itemCount++;
            }
            reply += `\n`;
        }
        
        if (!wasTruncated && otherItems.length > 0) {
            reply += `**‡∂≠‡∑Ä‡∂≠‡∑ä ‡∑Ä‡∑í‡∂ö‡∂Ω‡∑ä‡∂¥:**\n`;
            for (let i = 0; i < otherItems.length; i++) {
                if (itemCount >= maxItems) {
                    wasTruncated = true;
                    break;
                }
                const item = otherItems[i];
                const cleanDesc = removeSizeFromDescription(item.description, size);
                reply += `  ‚Ä¢ ${cleanDesc}\n`;
                itemCount++;
            }
            reply += `\n`;
        }
        
        if (wasTruncated) {
            reply += `${rules.truncationMessage_si}\n\n`;
        }
        
        reply += `‡∂∏‡∑í‡∂Ω ‡∂ú‡∂´‡∂±‡∑ä ‡∑É‡∑Ñ ‡∂î‡∂∂‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂ß‡∂∫‡∂ª‡∂∫ ‡∂¥‡∑í‡∑Ö‡∑í‡∂∂‡∂≥ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß, ‡∂¥‡∑Ñ‡∂≠ link ‡∂ë‡∂ö ‡∑Ñ‡∂ª‡∑Ñ‡∑è WhatsApp ‡∂î‡∑É‡∑ä‡∑É‡∑ö ‡∂Ö‡∂¥ ‡∑É‡∂∏‡∂ü ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∂±‡∑ä‡∂±.\n\n`;
        
        reply += `üì≤ **Get Expert Advice & Pricing:**\n`;
        reply += `üëâ ${link}\n\n`;
        reply += `üìû **Call Us:** ${WHATSAPP_NUMBER}\n`;
        reply += `(Lasantha Tyre Traders - Your Trusted Tyre Partner)`;
        
        return reply;
    }

    // English Format with full descriptions
    const link = `https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`Requesting quote for ${size}`)}`;
    
    let reply = `Thank you for your inquiry. We confirm that size ${size} is currently available.\n\n`;
    
    reply += `**Available Options:**\n\n`;
    
    let itemCount = 0;
    const maxItems = rules.maxItemsBeforeTruncation;
    let wasTruncated = false;
    
    if (performanceItems.length > 0) {
        reply += `**Performance:**\n`;
        for (let i = 0; i < performanceItems.length; i++) {
            if (itemCount >= maxItems) {
                wasTruncated = true;
                break;
            }
            const item = performanceItems[i];
            const cleanDesc = removeSizeFromDescription(item.description, size);
            reply += `  ‚Ä¢ ${cleanDesc}\n`;
            itemCount++;
        }
        reply += `\n`;
    }
    
    if (!wasTruncated && valueDurabilityItems.length > 0) {
        reply += `**Value & Durability:**\n`;
        for (let i = 0; i < valueDurabilityItems.length; i++) {
            if (itemCount >= maxItems) {
                wasTruncated = true;
                break;
            }
            const item = valueDurabilityItems[i];
            const cleanDesc = removeSizeFromDescription(item.description, size);
            reply += `  ‚Ä¢ ${cleanDesc}\n`;
            itemCount++;
        }
        reply += `\n`;
    }
    
    if (!wasTruncated && otherItems.length > 0) {
        reply += `**Other Options:**\n`;
        for (let i = 0; i < otherItems.length; i++) {
            if (itemCount >= maxItems) {
                wasTruncated = true;
                break;
            }
            const item = otherItems[i];
            const cleanDesc = removeSizeFromDescription(item.description, size);
            reply += `  ‚Ä¢ ${cleanDesc}\n`;
            itemCount++;
        }
        reply += `\n`;
    }
    
    if (wasTruncated) {
        reply += `${rules.truncationMessage_en}\n\n`;
    }
    
    reply += `For complete pricing details and expert advice, please contact us via WhatsApp.\n\n`;
    
    reply += `**Contact for Quotation:**\n`;
    reply += `${link}\n\n`;
    reply += `**Direct Line:** ${WHATSAPP_NUMBER}`;
    
    return reply;
}

async function generateAI(msg, scenario, size, lang) {
    try {
        const model = genAI.getGenerativeModel({ model: 'gemini-pro' });
        let prompt = lang === 'si' 
            ? `‡∂î‡∂∂ Lasantha Tyre Traders AI. WhatsApp: wa.me/94721222509. ‡∂ö‡∑ô‡∂ß‡∑í reply (3 lines). Customer: "${msg}"`
            : `You are Lasantha Tyre Traders AI. WhatsApp: wa.me/94721222509. Short reply (3 lines). Customer: "${msg}"`;
        
        const result = await model.generateContent(prompt);
        return result.response.text();
    } catch (error) {
        return lang === 'si' ? `üôè ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª:
üì± wa.me/94721222509` : `üôè Details:
üì± wa.me/94721222509`;
    }
}

function detectLanguage(text) {
    const lowerText = text.toLowerCase();
    
    // Check for Sinhala Unicode characters
    if (/[‡∂Ä-‡∑ø]/.test(text)) {
        return 'si';
    }
    
    // Common Sinhala/Singlish words and phrases
    const sinhalaKeywords = [
        'tyre', 'tire', 'thiyenawada', 'thiyenawada', '‡∂≠‡∂∫‡∂ª‡∑ä', 'tayar',
        'kiyada', '‡∂ö‡∑ì‡∂∫‡∂Ø', '‡∂∏‡∑í‡∂Ω', 'mila', '‡∂∏‡∑ú‡∂ö‡∂Ø‡∑ä‡∂Ø', 'mokadda',
        'thiyeda', '‡∂≠‡∑í‡∂∫‡∑ô‡∂Ø', 'awada', '‡∂Ü‡∑Ä‡∂Ø', '‡∂ë‡∂±‡∑Ä‡∂Ø', 'enavada',
        'ganna', '‡∂ú‡∂±‡∑ä‡∂±', '‡∂Ø‡∑ô‡∂±‡∑ä‡∂±', 'denna', '‡∂∂‡∂Ω‡∂±‡∑ä‡∂±', 'balanna',
        'kawuda', '‡∂ö‡∑Ä‡∑î‡∂Ø', 'kohenda', '‡∂ö‡∑ú‡∑Ñ‡∑ô‡∂±‡∑ä‡∂Ø', 'kiyada', '‡∂ö‡∑ì‡∂∫‡∂Ø',
        'ekak', '‡∂ë‡∂ö‡∂ö‡∑ä', 'tikak', '‡∂≠‡∑í‡∂ö‡∂ö‡∑ä', 'hodai', '‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í',
        'onida', '‡∂ï‡∂±‡∑í‡∂Ø', '‡∂¥‡∑î‡∑Ö‡∑î‡∑Ä‡∂±‡∑ä‡∂Ø', 'puluwanda', '‡∂≠‡∂∏‡∂∫‡∑í', 'tamai',
        'neda', '‡∂±‡∑ë‡∂Ø', 'na', '‡∂±‡∑ë', 'ow', '‡∂î‡∑Ä‡∑ä', 'epa', '‡∂ë‡∂¥‡∑è',
        'oya', '‡∂î‡∂∫', 'meka', '‡∂∏‡∑ö‡∂ö', 'ara', '‡∂Ö‡∂ª', 'api', '‡∂Ö‡∂¥‡∑í',
        'mama', '‡∂∏‡∂∏', 'mata', '‡∂∏‡∂ß', 'kohomada', '‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø',
        'da', '‡∂Ø', 'ne', '‡∂±‡∑ö', 'no', '‡∂±‡∑ù', 'ekada', '‡∂ë‡∂ö‡∂Ø'
    ];
    
    // Count Singlish/Sinhala keyword matches
    const matchCount = sinhalaKeywords.filter(keyword => 
        lowerText.includes(keyword)
    ).length;
    
    // If 2 or more Sinhala keywords found, treat as Sinhala
    if (matchCount >= 2) {
        return 'si';
    }
    
    // Check for common pure English patterns
    const englishPatterns = [
        /\b(how much|price|cost|available|stock|have|need|want|looking for|interested in)\b/i,
        /\b(is|are|do|does|can|could|would|should|will)\b.*\b(you|your|there)\b/i
    ];
    
    const hasEnglishPattern = englishPatterns.some(pattern => pattern.test(text));
    
    // If clear English pattern and no Sinhala keywords, return English
    if (hasEnglishPattern && matchCount === 0) {
        return 'en';
    }
    
    // If single Sinhala keyword found (ambiguous), default to Sinhala for better UX
    if (matchCount >= 1) {
        return 'si';
    }
    
    // Default: if no clear indicators, assume English
    return 'en';
}

/**
 * Handle follow-up/contextual replies when user replies to bot's comment
 */
async function handleContextualReply(message, context, lang, mainPool) {
    const { tyreSize, brands } = context;
    const msgLower = message.toLowerCase();
    
    console.log(`[FB Handler] ü§î Analyzing contextual question: "${message}"`);
    
    // Check if asking about specific brand availability
    const brandMentioned = brands.find(b => msgLower.includes(b.toLowerCase()));
    
    if (brandMentioned) {
        console.log(`[FB Handler] üè∑Ô∏è User asking about brand: ${brandMentioned}`);
        
        if (lang === 'si') {
            return `‡∂î‡∑Ä‡∑ä, ${brandMentioned.toUpperCase()} brand ‡∂ë‡∂ö ${tyreSize} size ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è! ‚úÖ\n\n‡∂∏‡∑í‡∂Ω ‡∑É‡∑Ñ ‡∂≠‡∑ú‡∂ú‡∂∫ ‡∂¥‡∑í‡∑Ö‡∑í‡∂∂‡∂≥ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`${brandMentioned} ${tyreSize} price`)}\n\nüìû ${WHATSAPP_NUMBER}`;
        } else {
            return `Yes, we have ${brandMentioned.toUpperCase()} in size ${tyreSize}! ‚úÖ\n\nFor pricing and stock details:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`${brandMentioned} ${tyreSize} price`)}\n\nüìû ${WHATSAPP_NUMBER}`;
        }
    }
    
    // Check if asking which brands are available
    if (msgLower.includes('brand') || msgLower.includes('‡∂∂‡∑ä‚Äç‡∂ª‡∑ë‡∂±‡∑ä‡∂©‡∑ä') || msgLower.includes('‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä‡∂±‡∑ö')) {
        console.log(`[FB Handler] üìã User asking for brand list`);
        
        const brandList = brands.slice(0, 6).join(', ').toUpperCase();
        const hasMore = brands.length > 6;
        
        if (lang === 'si') {
            return `${tyreSize} size ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂± brands:\n\n${brandList}${hasMore ? ` ‡∑É‡∑Ñ ‡∂≠‡∑Ä‡∂≠‡∑ä ${brands.length - 6}‡∂ö‡∑ä` : ''}\n\n‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`${tyreSize} brands`)}\n\nüìû ${WHATSAPP_NUMBER}`;
        } else {
            return `Available brands for ${tyreSize}:\n\n${brandList}${hasMore ? ` and ${brands.length - 6} more` : ''}\n\nFor more details:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`${tyreSize} brands`)}\n\nüìû ${WHATSAPP_NUMBER}`;
        }
    }
    
    // Check if asking about prices
    if (msgLower.includes('price') || msgLower.includes('‡∂∏‡∑í‡∂Ω') || msgLower.includes('‡∂ö‡∑ì‡∂∫‡∂Ø')) {
        console.log(`[FB Handler] üí∞ User asking about prices`);
        
        if (lang === 'si') {
            return `${tyreSize} ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∏‡∑í‡∂Ω ‡∂ú‡∂´‡∂±‡∑ä brand ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è.\n\n‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ brands ‡∑É‡∑Ñ ‡∂∏‡∑í‡∂Ω:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`${tyreSize} prices`)}\n\nüìû ${WHATSAPP_NUMBER}\n(Lasantha Tyre Traders)`;
        } else {
            return `Prices for ${tyreSize} vary by brand.\n\nFor complete pricing:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}?text=${encodeURIComponent(`${tyreSize} prices`)}\n\nüìû ${WHATSAPP_NUMBER}\n(Lasantha Tyre Traders)`;
        }
    }
    
    // Generic contextual response using AI
    console.log(`[FB Handler] ü§ñ Using AI for contextual reply`);
    
    try {
        const model = genAI.getGenerativeModel({ model: 'gemini-pro' });
        const prompt = lang === 'si'
            ? `‡∂î‡∂∂ Lasantha Tyre Traders AI. Customer ‡∑Ä‡∑í‡∂∏‡∑É‡∑ì‡∂∏‡∂ö‡∑ä ‡∂ö‡∑Ö‡∑è "${tyreSize}" ‡∂ú‡∑ê‡∂± ‡∑É‡∑Ñ ‡∂Ö‡∂¥‡∑í ‡∂ö‡∑í‡∑Ä‡∑ä‡∑Ä‡∑è brands: ${brands.slice(0,3).join(', ')} ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è ‡∂ö‡∑í‡∂∫‡∂Ω‡∑è. ‡∂Ø‡∑ê‡∂±‡∑ä customer ‡∂Ö‡∑Ñ‡∂±‡∑Ä‡∑è: "${message}". ‡∂ö‡∑ô‡∂ß‡∑í, helpful reply ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂± (2-3 lines). WhatsApp: wa.me/94721222509`
            : `You are Lasantha Tyre Traders AI. Customer asked about "${tyreSize}" and we mentioned brands: ${brands.slice(0,3).join(', ')}. Now customer asks: "${message}". Give a short, helpful reply (2-3 lines). WhatsApp: wa.me/94721222509`;
        
        const result = await model.generateContent(prompt);
        return result.response.text();
    } catch (error) {
        // Fallback
        return lang === 'si'
            ? `${tyreSize} ‡∂¥‡∑í‡∑Ö‡∑í‡∂∂‡∂≥ ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}\nüìû ${WHATSAPP_NUMBER}`
            : `For more details about ${tyreSize}:\nüëâ https://wa.me/94${WHATSAPP_NUMBER.substring(1)}\nüìû ${WHATSAPP_NUMBER}`;
    }
}

module.exports = { handleFacebookComment };
